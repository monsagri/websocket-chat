{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./handler.js","webpack:///./repositories/channels.js","webpack:///./repositories/connections.js","webpack:///./repositories/dynamodb.js","webpack:///./services/index.js","webpack:///./util/index.js","webpack:///external \"@babel/runtime/helpers/interopRequireDefault\"","webpack:///external \"@babel/runtime/helpers/interopRequireWildcard\"","webpack:///external \"aws-sdk\"","webpack:///external \"source-map-support/register\""],"names":["success","statusCode","connectionHandler","requestContext","connectionId","routeKey","service","saveConnectionInfoToDynamoDB","deleteConnectionInfoFromDynamoDB","defaultRoute","event","console","log","test","messageHandler","payload","JSON","parse","body","subscribers","getSubscribersToChannel","channelId","messages","map","subscriber","sendMessageToSubscriber","Promise","all","listConnections","tableName","process","env","MESSAGE_TABLE","subscribeToChannel","CONNECTION_TABLE","add","addResult","dynamoDb","addToTable","remove","removeResult","removeByPrimary","keyName","scanTable","Items","AWS","config","update","region","endpoint","dynamodbClient","DynamoDB","DocumentClient","Item","TableName","params","putResult","put","promise","itemKey","type","Key","delete","updateItem","allResults","scan","connectionRepo","channelRepo","listSubscribers","messageRepo","sendMessage","responseBuilder","func","result","stringify","e"],"mappings":"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","file":"handler.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./handler.js\");\n","import { responseBuilder } from './util'\nimport * as service from './services'\n\nconst success = {\n  statusCode: 200\n}\n\nexport const connectionHandler = responseBuilder(async ({ requestContext: { connectionId, routeKey } }) =>\n  routeKey === '$connect'\n    ? await service.saveConnectionInfoToDynamoDB(connectionId)\n    : await service.deleteConnectionInfoFromDynamoDB(connectionId)\n)\n\nexport const defaultRoute = async event => {\n  console.log('event in default: ', event)\n  return success\n}\n\nexport const test = async event => {\n  console.log('event in test: ', event)\n  return success\n}\n\n// assume there is other logic and processes that save \"channel\" subscriptions for each\n// subscriber, along with their connectionId information\n\nexport const messageHandler = async event => {\n  const payload = JSON.parse(event.body)\n\n  // fetch anyone subscribed to a channel defined in payload for a datastore\n  const subscribers = await service.getSubscribersToChannel(payload.channelId)\n\n  // for each subscriber to the channel, we have to send a message per connection\n  // (no batch, one call to Api Gateway Management API per message)\n  const messages = subscribers.map(async subscriber => {\n    return service.sendMessageToSubscriber(subscriber.connectionId, payload)\n  })\n\n  // make sure they all send\n  await Promise.all(messages)\n\n  // still have to let api gateway know we were succesful!\n  return success\n}\n\nexport const listConnections = responseBuilder(async () => await service.listConnections())\n","import { addToTable } from './dynamodb'\n\nconst tableName = process.env.MESSAGE_TABLE\n\nexport const subscribeToChannel = async (connectionId, channelId) => {\n  return await addToTable({channelId, connectionId}, tableName)\n}\n","import * as dynamoDb from './dynamodb'\n\nconst tableName = process.env.CONNECTION_TABLE\n\nexport const add = async connectionId => {\n  console.log('connecting')\n  const addResult = await dynamoDb.addToTable({ connectionId }, tableName)\n  console.log('addResult', addResult)\n  return addResult\n}\n\nexport const remove = async connectionId => {\n  console.log('removing', connectionId)\n  const removeResult = await dynamoDb.removeByPrimary(connectionId, tableName, { keyName: 'connectionId' })\n  console.log('removeResult', removeResult)\n  return removeResult\n}\n\nexport const listConnections = async () => (await dynamoDb.scanTable(tableName)).Items\n","import AWS from 'aws-sdk'\n\nAWS.config.update({\n  region: 'eu-west-2',\n  endpoint: 'https://dynamodb.eu-west-2.amazonaws.com'\n})\n\nconst dynamodbClient = new AWS.DynamoDB.DocumentClient()\n\nexport const addToTable = async (Item, TableName) => {\n  const params = {\n    TableName,\n    Item\n  }\n  console.log('adding with params:', params)\n  const putResult = await dynamodbClient.put(params).promise()\n  console.log('result from putting:', putResult)\n  return putResult\n}\n\nexport const removeByPrimary = async (itemKey, TableName, { keyName, type = 'S' }) => {\n  const params = {\n    TableName,\n    Key: {\n      [keyName]: {\n        [type]: itemKey\n      }\n    }\n  }\n  console.log('removing with params ', params)\n  const removeResult = await dynamodbClient.delete(params).promise()\n  console.log('result from deleting:', removeResult)\n}\n\n// This is the only way it seems to get stuff into a list, but it looks like a fucking pain\n// where is momngoose when you need it\nexport const updateItem = async () => {\n  // const updateResult = await dynamodbClient.updateItem().promise\n  console.log('need to make updateItem work')\n}\n\nexport const scanTable = async TableName => {\n  const params = {\n    TableName\n  }\n  const allResults = await dynamodbClient.scan(params).promise()\n  console.log('found,', allResults)\n  return allResults\n}\n","import * as channelRepo from '../repositories/channels'\nimport * as connectionRepo from '../repositories/connections'\nimport * as messageRepo from '../repositories/messages'\n\nexport const saveConnectionInfoToDynamoDB = connectionRepo.add\nexport const deleteConnectionInfoFromDynamoDB = connectionRepo.remove\n\nexport const getSubscribersToChannel = channelRepo.listSubscribers\n\nexport const sendMessageToSubscriber = messageRepo.sendMessage\n\nexport const listConnections = connectionRepo.listConnections","export const responseBuilder = func => async () => {\n  try {\n    const result = await func()\n    console.log('about to return ', { statusCode: 200, body: JSON.stringify(result) })\n    return { statusCode: 200, body: JSON.stringify(result) }\n  } catch (e) {\n    return { statusCode: 500, body: e }\n  }\n}\n","module.exports = require(\"@babel/runtime/helpers/interopRequireDefault\");","module.exports = require(\"@babel/runtime/helpers/interopRequireWildcard\");","module.exports = require(\"aws-sdk\");","module.exports = require(\"source-map-support/register\");"],"sourceRoot":""}